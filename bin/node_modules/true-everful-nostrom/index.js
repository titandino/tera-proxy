module.exports = function TrueEverfulNostrom(dispatch) {
	let cid = null,
		slot = -1,
		timeout = null,
		cooldown = 0,
		alive = false

	dispatch.hook('S_LOGIN', 1, event => { ({cid} = event) })

	dispatch.hook('S_PCBANGINVENTORY_DATALIST', 1, event => {
		for(let item of event.inventory)
			if(item.item == 184659) {
				if(item.cooldown) cooldown = Date.now() + item.cooldown

				slot = item.slot

				item.cooldown = 0 // Cooldowns from this packet don't seem to do anything except freeze your client briefly
				return true
			}
	})

	dispatch.hook('S_LOAD_TOPO', 1, event => { nostrom(false) })
	dispatch.hook('S_SPAWN_ME', 1, event => { nostrom(alive = event.alive) })
	dispatch.hook('S_CREATURE_LIFE', 1, event => {
		if(event.target.equals(cid) && alive != event.alive) nostrom(alive = event.alive)
	})

	function nostrom(use) {
		clearTimeout(timeout)

		if(use && slot != -1) {
			let time = Date.now()

			if(time >= cooldown) {
				dispatch.toServer('C_PCBANGINVENTORY_USE_SLOT', 1, {slot})
				timeout = setTimeout(nostrom, 1200000, true)
			}
			else timeout = setTimeout(nostrom, cooldown - time, true)
		}
	}
}